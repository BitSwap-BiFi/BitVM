<scipt src="https://bundle.run/noble-secp256k1@1.2.14"></script>
<script src="https://unpkg.com/@cmdcode/tapscript@1.4.1"></script>
<script src="esplora.js"></script>
<script>
// const secp256k1 = nobleSecp256k1
const { Tap, Tx, Address, Signer } = tapscript

// Sample secret / public key pair.
const seckey_paul = '730fff80e1413068a05b57d6a58261f07551163369787f349438ea38ca80fac6'
const pubkey_paul = '07b8ae49ac90a048e9b53357a2354b3334e9c8bee813ecb98e99a7e07e8c3ba3'

const seckey_vicky = 'b2fc784510e7a9d7071f6e2bd5b35dcc49746ad1709b28438a44782b777058cf'
const pubkey_vicky = '04d72a760a4473ebb80ba650f2f43f87299e60272d26d571e6897113edc6181941d2ecd8f1b761812a317e72470a63c2534fd1d134097bbf426e0774dafe9d24f7'

// Challenge transaction
// We only need to check pauls signature because paul doesn't know the preimages.
// TODO: Fill in the correct 1-bit commitment
const challenge_scripts = [
    [1, 7, 'OP_ADD', 8, 'OP_EQUALVERIFY', pubkey_paul, 'OP_CHECKSIG'],
]

const challenge_tree = challenge_scripts.map(s => Tap.encodeScript(s))
const challenge_target = Tap.encodeScript(challenge_scripts[0])

const [challenge_tseckey] = Tap.getSecKey(seckey_paul, { challenge_tree, challenge_target })
const [challenge_tpubkey, challenge_cblock] = Tap.getPubKey(pubkey_paul, { challenge_tree, challenge_target })

// Response transaction
// TODO: Fill in 160-bit commitment.
const response_scripts = [
    [1, 7, 'OP_ADD', 8, 'OP_EQUALVERIFY', pubkey_vicky, 'OP_CHECKSIG'],
]

const response_tree = response_scripts.map(s => Tap.encodeScript(s))
const response_target = Tap.encodeScript(response_scripts[0])

const [response_tseckey] = Tap.getSecKey(seckey_paul, { response_tree, response_target })
const [response_tpubkey, response_cblock] = Tap.getPubKey(pubkey_paul, { response_tree, response_target })

const challenge_address = Address.p2tr.fromPubKey(challenge_tpubkey, 'signet')
console.log("CHALLENGE ADDRESS", challenge_address)
const response_address = Address.p2tr.fromPubKey(response_tpubkey, 'signet')

// Challenge transaction
const challenge_txdata = Tx.create({
    vin: [{
        // The txid of your funding transaction.
        txid: '1766b5f521ca21d23eb6778ad054efb2915df404ec2f513157884886fc33749a',
        // The index of the output you are spending.
        vout: 0,
        // For Taproot, we need to specify this data when signing.
        prevout: {
            // The value of the output we are spending.
            value: 100_000,
            // This is the script that our taproot address decodes into.
            scriptPubKey: Address.toScriptPubKey(challenge_address)
        },
    }],
    vout: [{
        // We are locking up 99_000 sats (minus 1000 sats for fees.)
        value: 99_000,
        // We are locking up funds to this address.
        scriptPubKey: Address.toScriptPubKey(response_address)
    }]      
})

const challenge_txhex_unsigned = Tx.encode( challenge_txdata ).hex
const challenge_txid = Tx.util.getTxid( challenge_txhex_unsigned )
console.log('CHALLENGE TXID', challenge_txid)

// Paul signs both spending taproot transactions
const challenge_sig = Signer.taproot.sign(seckey_paul, challenge_txdata, 0, { extension: challenge_target })

// TODO reveal preimage here in witness
challenge_txdata.vin[0].witness = [challenge_sig.hex, challenge_scripts[0], challenge_cblock]


const txhex = Tx.encode(challenge_txdata).hex

console.log(challenge_address, challenge_txdata)
console.log(txhex)
console.log(broadcastTransaction(txhex))


// Response transaction
const response_txdata = Tx.create({
    vin: [{
        // The txid of the previous challenge tx.
        txid: challenge_txid,
        // The index of the output you are spending.
        vout: 0,
        // For Taproot, we need to specify this data when signing.
        prevout: {
            // The value of the output we are spending.
            value: 99_000,
            // This is the script that our taproot address decodes into.
            scriptPubKey: Address.toScriptPubKey(response_address)
        },
    }],
    vout: [{
        // We are locking up 99_000 sats (minus 1000 sats for fees.)
        value: 98_000,
        // We are locking up funds to this address. // TODO next challenge tx
        scriptPubKey: pubkey_paul
    }]      
})

const response_txhex_unsigned = Tx.encode( response_txdata ).hex
const response_txid = Tx.util.getTxid( response_txhex_unsigned )
console.log('RESPONSE TXID', response_txid)

// Paul signs both spending taproot transactions
const response_sig_0 = Signer.taproot.sign(seckey_paul, response_txdata, 0, { extension: response_target })
// TODO reveal preimages here in witness
challenge_txdata.vin[0].witness = [challenge_sig.hex, challenge_scripts[0], challenge_cblock]

const response_txhex = Tx.encode(challenge_txdata).hex

console.log(challenge_address, challenge_txdata)
console.log(response_txhex)
console.log(broadcastTransaction(response_txhex))
</script>
